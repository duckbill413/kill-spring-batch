# FlatFileWriter (죽음을 파일에 새기다 ☠️)

- 데이터를 플랫 파일 형식으로 쓰는 작업을 담당

## 필드 추출과 라인 결합

- 파일에서 읽은 도메인 객체를 CSV 형식이나 커스텀 형식으로 변환하여 파일에 기록하는 역할을 `FieldExtrator` 와 `LineAggregator` 가 수행한다.

### 1단계: `FieldExtractor` (필드 추출)

- FieldExtractor 는 도메인 객체에서 필드를 추출하는 역할을 한다.

**`BeanWrapperFieldExtractor` vs `RecordFieldExtractor`: 필드 추출의 두 얼굴

- `BeanWrapperFieldExtractor` 는 java bean 객체로 부터 필드를 추출
- `RecordFieldExtractor` 는 java record 에서 필드를 추출하는 FieldExtractor, 레코드 컴포넌트의 accessor 메서드를 호출하여 값을 가져온다.
- Spring Batch 는 파일에 쓸 도메인 객체의 타입에 따라 두 구현체 중 하나를 자동으로 선택한다. 도메인 객체가 Java Bean 이면 `BeanWrapperFieldExtractor` 가 사용되고,
  Java Record 이면 `RecordFieldExtractor` 가 사용된다.

### 2단계: `LineAggregator` (문자열 결함)

- `LineAggregator` 는 FieldExtractor 에서 추출한 데이터를 하나의 문자열로 결합하는 역할을 맡는다.
- CSV 형식으로 결합할 수 있고, 커스텀 형식으로 데이터를 포맷할 수도 있다.
- 구분자 기반 형식의 파일을 읽을 때 DelimitedLineTokenizer 가 사용된 것 처럼, 구분자 기반 형식으로 파일을 쓸때는 `DelimitedLineAggregator` 가 사용된다.
- 또한, 고정 길이 형식을 포함한 다른 형식으로 파일을 쓸 때는 `FormatterLineAggregator` 를 사용할 수 있다.

![FlatFileWriter-1](FlatFileWriter-1.png)

```java
// FlatFileItemWriter.doWrite() -> write()에서 호출
public String doWrite(Chunk<? extends T> items) {
  StringBuilder lines = new StringBuilder();
  for (T item : items) {
    lines.append(this.lineAggregator.aggregate(item)).append(this.lineSeparator);
  }
  return lines.toString();
}
```

- FlatFileWriter 는 객체를 한 줄의 문자열로 만들어 파일에 쓴다. 이때 실제 객체 -> 문자열 변환은 LineAggregator 가 담당하는데, `DelimitedLineAggregator` 와
  `FormatterLineAggregator` 중 하나를 쓴다.
- DelimitedLineAggregator와 FormatterLineAggregator는 ExtractorLineAggregator를 상속한다. 이 ExtractorLineAggregator 계열의
  LineAggregator 구현체는 내부적으로 FieldExtractor를 사용해 객체로부터 필드를 추출한다. FieldExtractor 구현체로는 BeanWrapperFieldExtractor와
  RecordFieldExtractor가 사용되는데, Spring Batch는 도메인 객체의 타입에 따라 적절한 구현체를 자동으로 선택한다.
- names() 메서드는 자동 구성 방식에서만 사용된다는 사실에 주의하라. fieldExtractor() 메서드를 사용해 FieldExtractor 객체를 직접 전달한 경우에는 names() 메서드 설정은
  무시된다.

> 실습
> - bootRun 실행
> ```shell
> ./gradlew bootRun --args='--spring.batch.job.name=deathNoteWriteJob outputDir=src/main/java/com/system/batch/session3/작전2'
> ```